// SPDX-License-Identifier: MIT
pragma solidity 0.8.22;

/* solhint-disable max-line-length */

import { Test } from "forge-std/Test.sol";
import { Strings } from "@openzeppelin/contracts/utils/Strings.sol";

contract ParaSwapSnapshot is Test {
    mapping(uint256 blockNumber => mapping(address fromToken => mapping(address toToken => mapping(uint256 amount => mapping(address userAddr => mapping(uint256 maxImpact => bytes swapData))))))
        public snapshots;

    constructor() {
        _populateSnapshot();
    }

    /// @notice Get paraswap data
    ///         The Paraswap SDK fetches the best route from its API at the current block, which makes the fork tests not 100% reproductible.
    ///         This function loads results from `snapshot` if available, otherwise calls paraswap.ts
    /// @dev Using paraswap.ts and `vm.ffi` to get paraswap data with the Node.js SDK
    function _getParaswapData(
        address fromToken,
        address toToken,
        uint256 amount,
        address userAddr,
        uint256 maxImpact
    ) internal returns (bytes memory) {
        if (snapshots[block.number][fromToken][toToken][amount][userAddr][maxImpact].length > 0) {
            return snapshots[block.number][fromToken][toToken][amount][userAddr][maxImpact];
        }

        string[] memory inputs = new string[](8);
        inputs[0] = "npx";
        inputs[1] = "ts-node";
        inputs[2] = "./script/paraswap.ts";
        inputs[3] = Strings.toHexString(fromToken);
        inputs[4] = Strings.toHexString(toToken);
        inputs[5] = Strings.toString(amount);
        inputs[6] = Strings.toHexString(userAddr);
        inputs[7] = Strings.toString(maxImpact);

        bytes memory res = vm.ffi(inputs);
        return res;
    }

    function _populateSnapshot() internal {
        snapshots[19_330_000][0x6B175474E89094C44Da98b954EedeAC495271d0F][0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0][
            5000000000000000000000
        ][0x55d206c1A11F4b2f60459e88B5c601A4E1Cd41a5][
            100
        ] = hex"0b86a4c10000000000000000000000006b175474e89094c44da98b954eedeac495271d0f00000000000000000000000000000000000000000000010f0cf064dd592000000000000000000000000000000000000000000000000000000248608b4489d5f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000004de4c5578194d457dcce3f272538d1ad52c68d1ce849";
        snapshots[19_330_000][0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0][0x6B175474E89094C44Da98b954EedeAC495271d0F][
            1072161001456551580
        ][0x55d206c1A11F4b2f60459e88B5c601A4E1Cd41a5][
            100
        ] = hex"a6886da900000000000000000000000000000000000000000000000000000000000000200000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca00000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000e592427a0aece92de3edee1f18e0157c058615640000000000000000000000000000000000000000000000000ee114c011d8469c00000000000000000000000000000000000000000000003547d0341bce548ef500000000000000000000000000000000000000000000010a6711048b07a6cac501000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000065eb879300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000024097548a4f776740919920b573ae786c6a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000427f39c581f595b53c5cb19bd0b3f8da6c935e2ca00001f4a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000646b175474e89094c44da98b954eedeac495271d0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        snapshots[19_330_000][0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599][0x6B175474E89094C44Da98b954EedeAC495271d0F][
            40000000
        ][0x55d206c1A11F4b2f60459e88B5c601A4E1Cd41a5][
            100
        ] = hex"a6886da900000000000000000000000000000000000000000000000000000000000000200000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c5990000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000e592427a0aece92de3edee1f18e0157c058615640000000000000000000000000000000000000000000000000000000002625a000000000000000000000000000000000000000000000001280ef8b7aae0b8c9260000000000000000000000000000000000000000000005c84adb9656639bedba01000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000065ecffc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000024006c465a6328d46048ac9f990e3ae2d390000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000422260fac5e5542a773aa44fbcfedf7c193bc2c5990001f4c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f46b175474e89094c44da98b954eedeac495271d0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        snapshots[19_330_000][0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599][0x6B175474E89094C44Da98b954EedeAC495271d0F][
            20000000
        ][0x55d206c1A11F4b2f60459e88B5c601A4E1Cd41a5][
            100
        ] = hex"a6886da900000000000000000000000000000000000000000000000000000000000000200000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c5990000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000e592427a0aece92de3edee1f18e0157c058615640000000000000000000000000000000000000000000000000000000001312d000000000000000000000000000000000000000000000000940a7085178e1b6e1d0000000000000000000000000000000000000000000002e434329975c689269001000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000065ed040800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002402aef0699115b40a3b75649a1de06f7e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000422260fac5e5542a773aa44fbcfedf7c193bc2c5990001f4a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000646b175474e89094c44da98b954eedeac495271d0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    }
}
